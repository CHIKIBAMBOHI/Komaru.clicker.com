<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komaru Combat</title>
    <style>
        /* --- CSS –°–¢–ò–õ–ò (–û—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —É –≤–∞—Å) --- */
        :root {
            --primary: #FFD93D; /* –ñ–µ–ª—Ç—ã–π –±–∞–Ω–∞–Ω */
            --secondary: #FF6B6B; /* –†–æ–∑–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç */
            --bg-gradient: linear-gradient(135deg, #8A2BE2, #4B0082, #2d2d7a);
            --panel-bg: rgba(255, 255, 255, 0.1);
            --tab-active: #9B4DFF;
            --text: #ffffff;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            touch-action: manipulation; /* –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Å–≤–µ—á–µ–Ω–∏—è */
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .game-title {
            font-size: 3em;
            margin: 0;
            background: linear-gradient(45deg, #FF6B6B, #FFD93D, #9B4DFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255, 107, 107, 0.5); }
            to { text-shadow: 0 0 30px rgba(255, 107, 107, 0.8), 0 0 40px rgba(255, 107, 107, 0.6); }
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 20px 0 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* –°–µ–∫—Ü–∏—è –ö–ª–∏–∫–µ—Ä–∞ (–í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å) */
        .clicker-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 40px rgba(155, 77, 255, 0.3);
            height: 40%;
            min-height: 200px;
        }
        
        /* –°—Ç–∏–ª–∏ –∫–ª–∏–∫–µ—Ä–∞ */
        .score-display { font-size: 4em; font-weight: bold; color: var(--primary); text-shadow: 0 0 15px rgba(255, 217, 61, 0.5); margin-bottom: 5px; }
        .rate-display { font-size: 1.2em; color: #ddd; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; }

        #click-btn {
            width: 150px;
            height: 150px;
            max-width: 40vw; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
            max-height: 40vw; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
            border-radius: 50%;
            background: radial-gradient(circle, #FFD93D, #FF6B6B);
            border: 8px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 0 50px rgba(255, 107, 107, 0.5);
            outline: none;
            overflow: hidden;
            position: relative; /* –î–ª—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        }
        
        #click-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; opacity: 0.9; transition: transform 0.1s; }
        #click-btn:active { transform: scale(0.95); box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
        #click-btn:active img { transform: scale(1.1) rotate(5deg); }


        /* --- –°–µ–∫—Ü–∏—è –í–∫–ª–∞–¥–æ–∫ (–ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å) --- */
        .tab-section {
            flex: 1;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: 25px 25px 0 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ */
        .tab-nav {
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 0;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s, background 0.3s;
        }

        .tab-button.active {
            color: var(--primary);
            background: var(--tab-active);
            box-shadow: 0 5px 10px rgba(155, 77, 255, 0.5);
        }
        /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 600px) {
            .tab-button {
                font-size: 0.9em;
                padding: 12px 5px;
            }
        }


        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .content-panel { display: none; }
        .content-panel.active { display: block; }

        /* –°—Ç–∏–ª–∏ –£–ª—É—á—à–µ–Ω–∏–π/–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π */
        .section-title { color: var(--primary); margin-bottom: 15px; font-size: 1.3em; text-align: center; }
        .upgrade-item, .achievement-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .achievement-icon { font-size: 2em; margin-right: 15px; filter: grayscale(100%); opacity: 0.5; transition: filter 0.5s, opacity 0.5s; }
        .achievement-unlocked .achievement-icon { filter: grayscale(0%); opacity: 1; text-shadow: 0 0 10px var(--primary); }
        
        .buy-btn {
            background: var(--primary);
            color: #333;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 10px;
            transition: background 0.2s;
            white-space: nowrap; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ü–µ–Ω—ã */
        }
        .buy-btn:not([disabled]):hover {
            background: #ffe369;
        }
        .buy-btn[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }

        /* --- –°—Ç–∏–ª–∏ –ë–æ–Ω—É—Å–Ω–æ–≥–æ –ü–æ–ø–∞–ø–∞ --- */
        .bonus-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            background: rgba(0, 0, 0, 0.9);
            border: 5px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 50px var(--primary);
            z-index: 2000;
            transition: transform 0.5s ease-out, opacity 0.5s;
            opacity: 0;
            min-width: 300px;
        }
        
        .bonus-popup.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .bonus-popup img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 3px solid var(--secondary);
            box-shadow: 0 0 15px var(--secondary);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .bonus-message {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .bonus-button {
            background: var(--secondary);
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .bonus-button:hover {
            background: #d85050;
        }
        
        .lvl-badge {
            background: #9B4DFF;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        .floating-text {
            pointer-events: none;
            position: fixed;
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD93D;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
            animation: floatUp 1s ease-out forwards;
            z-index: 5000;
            user-select: none;
        }
        .floating-text.bonus {
             font-size: 2em;
             color: #9B4DFF;
             text-shadow: 0 0 15px #FFD93D;
        }
        @keyframes floatUp {
            0% {
                transform: translate(-50%, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50px) scale(0.8);
                opacity: 0;
            }
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –∏–≥—Ä–µ */
        .playtime-display {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <h1 class="game-title">Komaru Combat</h1>
        <p style="font-size: 0.8em; opacity: 0.6; margin-top: 5px;">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="user-id-display">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
    </header>

    <div class="main-content">
        <div class="clicker-section">
            <div class="score-display">üçå <span id="bananas-display">0</span></div>
            <!-- BPS –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –æ–¥–Ω–∏–º –∑–Ω–∞–∫–æ–º –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å –¥—Ä–æ–±–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (1.5 BPS) -->
            <div class="rate-display"><span id="bps-display">0.0</span> –±–∞–Ω–∞–Ω–æ–≤/—Å–µ–∫</div>
            
            <button id="click-btn" class="relative">
                <img src="uploaded:1000067958.png-b70b7cbe-2e2e-4195-b5d4-af65359359b8" alt="Komaru">
            </button>
            <p style="margin-top: 15px; opacity: 0.7; font-size: 0.9em;">–ö–ª–∏–∫–∞–π –ø–æ –ö–æ–º–∞—Ä—É!</p>
            
            <!-- –í—Ä–µ–º—è –≤ –∏–≥—Ä–µ -->
            <div class="playtime-display">
                ‚è≥ –í—Ä–µ–º—è –≤ –∏–≥—Ä–µ: <span id="playtime-display">00—á 00–º 00—Å</span>
            </div>
        </div>

        <div class="tab-section">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="click-upgrades">üëÜ –£–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–∞</button>
                <button class="tab-button" data-tab="auto-farm">ü§ñ –ê–≤—Ç–æ –§–∞—Ä–º</button>
                <button class="tab-button" data-tab="achievements">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
            </div>
            
            <div class="tab-content">
                <!-- –£–ª—É—á—à–µ–Ω–∏—è –ö–ª–∏–∫–∞ -->
                <div id="click-upgrades-content" class="content-panel active">
                    <h2 class="section-title">–£–ª—É—á—à–µ–Ω–∏—è –ö–ª–∏–∫–æ–≤–æ–≥–æ –î–æ—Ö–æ–¥–∞</h2>
                    <div id="click-upgrades-list"></div>
                </div>

                <!-- –ê–≤—Ç–æ –§–∞—Ä–º -->
                <div id="auto-farm-content" class="content-panel">
                    <h2 class="section-title">–°–∏—Å—Ç–µ–º—ã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –§–∞—Ä–º–∞</h2>
                    <div id="auto-farm-list"></div>
                </div>

                <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
                <div id="achievements-content" class="content-panel">
                    <h2 class="section-title">–°–ø–∏—Å–æ–∫ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</h2>
                    <div id="achievements-list"></div>
                </div>
            </div>
            
            <div style="padding: 10px; text-align: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <button class="reset-btn bonus-button" id="reset-btn" style="background: #e74c3c;">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
            </div>
        </div>
    </div>
    
    <div id="bonus-popup" class="bonus-popup">
        <img src="uploaded:1000069070.jpg-a19529ff-0cb6-4620-a306-2c97057ac350" alt="Komaru Bonus">
        <div class="bonus-message">"–í–æ—Ç –≤–∞–º –ø–æ–¥–∞—Ä–æ–∫!"</div>
        <button class="bonus-button" id="claim-bonus-btn">–ü–æ–ª—É—á–∏—Ç—å (üçå 0)</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        setLogLevel('debug');

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Canvas Environment (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-komaru-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --------------------------------------------------

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let gameStateUnsubscriber = null;
        
        let autoIncomeInterval = null;
        let playtimeUpdateInterval = null;
        let saveGameInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

        const SAVE_PATH = (uid) => `/artifacts/${appId}/users/${uid}/komaru_combat/state`;

        /* --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ --- */
        const gameConfig = {
            upgrades: [
                // –£–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–∞
                { id: 'click1', name: '–í–∫—É—Å–Ω—ã–π –±–∞–Ω–∞–Ω', type: 'click', baseCost: 15, basePower: 1, desc: '+1 –±–∞–Ω–∞–Ω –∑–∞ –∫–ª–∏–∫' },
                { id: 'click2', name: '–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫', type: 'click', baseCost: 100, basePower: 5, desc: '+5 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ –∫–ª–∏–∫' },
                { id: 'click3', name: '–ú–µ–≥–∞-–©–µ–ª—á–æ–∫', type: 'click', baseCost: 50000, basePower: 50, desc: '+50 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ –∫–ª–∏–∫' },
                { id: 'click4', name: '–ê–ª–º–∞–∑–Ω—ã–π –ö–æ–≥–æ—Ç—å', type: 'click', baseCost: 500000, basePower: 250, desc: '+250 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ –∫–ª–∏–∫' },
                { id: 'click5', name: '–ö–ª–∏–∫ –í—Å–µ–ª–µ–Ω–Ω–æ–π', type: 'click', baseCost: 5000000, basePower: 1000, desc: '+1–ö –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ –∫–ª–∏–∫' },
                
                // –ê–≤—Ç–æ –§–∞—Ä–º –£–ª—É—á—à–µ–Ω–∏—è (–ù–û–í–´–ï) - type: 'farm'
                // basePower - —ç—Ç–æ BPS (Bananas Per Second)
                // 1. –ë–∞–Ω–∞–Ω—á–∏–∫ —Ñ–∞—Ä–º: 15 / 10s = 1.5 BPS
                { id: 'farm1', name: '–ë–∞–Ω–∞–Ω—á–∏–∫ —Ñ–∞—Ä–º', type: 'farm', baseCost: 20000, basePower: 1.5, desc: '+15 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ 10 —Å–µ–∫ (1.5 BPS)' },
                // 2. –ö–æ–º–∞—Ä—É —Ö–∞–∫–µ—Ä —Ñ–∞—Ä–º: 100 / 10s = 10 BPS
                { id: 'farm2', name: '–ö–æ–º–∞—Ä—É —Ö–∞–∫–µ—Ä —Ñ–∞—Ä–º', type: 'farm', baseCost: 10000, basePower: 10, desc: '+100 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ 10 —Å–µ–∫ (10 BPS)' },
                // 3. –ë–∞–Ω–∞–Ω—á–∏–∫–∏ –∏ –∫–æ–º–∞—Ä—É: 500 / 10s = 50 BPS
                { id: 'farm3', name: '–ë–∞–Ω–∞–Ω—á–∏–∫–∏ –∏ –∫–æ–º–∞—Ä—É', type: 'farm', baseCost: 500000, basePower: 50, desc: '+500 –±–∞–Ω–∞–Ω–æ–≤ –∑–∞ 10 —Å–µ–∫ (50 BPS)' }
            ],
            achievements: [
                { id: 'ach1', title: '–ü–µ—Ä–≤—ã–π –ö–ª–∏–∫', icon: 'üëÜ', desc: '–ö–ª–∏–∫–Ω–∏—Ç–µ 1 —Ä–∞–∑.', check: (state) => state.totalClicks >= 1 },
                { id: 'ach2', title: '–ù–∞—á–∏–Ω–∞—é—â–∏–π –ö–ª–∏–∫–µ—Ä', icon: 'üê£', desc: '–ö–ª–∏–∫–Ω–∏—Ç–µ 100 —Ä–∞–∑.', check: (state) => state.totalClicks >= 100 },
                { id: 'ach3', title: '–ë–∞–Ω–∞–Ω–æ–≤—ã–π –ù–æ–≤–∏—á–æ–∫', icon: 'üí∞', desc: '–ù–∞–∫–æ–ø–∏—Ç–µ 500 –±–∞–Ω–∞–Ω–æ–≤.', check: (state) => state.totalBananas >= 500 },
                { id: 'ach4', title: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è', icon: '‚öôÔ∏è', desc: '–ö—É–ø–∏—Ç–µ —Ö–æ—Ç—è –±—ã 1 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ.', check: (state) => gameConfig.upgrades.filter(u => u.type === 'farm').some(u => state.items[u.id] > 0) },
                { id: 'ach5', title: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª', icon: '‚≠ê', desc: '–ù–∞–∫–æ–ø–∏—Ç–µ 10,000 –±–∞–Ω–∞–Ω–æ–≤.', check: (state) => state.totalBananas >= 10000 },
                { id: 'ach6', title: '–ú–∞–≥–Ω–∞—Ç', icon: 'üëë', desc: '–ù–∞–∫–æ–ø–∏—Ç–µ 1,000,000 –±–∞–Ω–∞–Ω–æ–≤.', check: (state) => state.totalBananas >= 1000000 }
            ]
        };

        const getDefaultState = () => {
            const defaultState = {
                bananas: 0,
                clickPower: 1,
                autoPower: 0, // –û–±—â–∞—è –º–æ—â–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–¥–æ—Ö–æ–¥–∞ –≤ BPS
                totalClicks: 0, 
                totalBananas: 0, 
                items: {}, 
                achievements: gameConfig.achievements.reduce((acc, ach) => {
                    acc[ach.id] = false;
                    return acc;
                }, {}),
                lastUpdateTime: Date.now(), 
                playtimeSeconds: 0 
            };
            gameConfig.upgrades.forEach(u => defaultState.items[u.id] = 0);
            return defaultState;
        };

        /* --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ --- */
        let gameState = getDefaultState();
        let currentBonusAmount = 0;
        let bonusTimer = null;

        /* --- DOM –≠–õ–ï–ú–ï–ù–¢–´ --- */
        const elBananas = document.getElementById('bananas-display');
        const elBps = document.getElementById('bps-display');
        const btnClick = document.getElementById('click-btn');
        const clickUpgradesList = document.getElementById('click-upgrades-list');
        const autoFarmList = document.getElementById('auto-farm-list');
        const achievementsList = document.getElementById('achievements-list');
        const tabNav = document.querySelector('.tab-nav');
        const btnReset = document.getElementById('reset-btn');
        const bonusPopup = document.getElementById('bonus-popup');
        const claimBonusBtn = document.getElementById('claim-bonus-btn');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const elPlaytime = document.getElementById('playtime-display');

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplayEl.textContent = userId.substring(0, 8) + '...';
                        console.log("Firebase Auth Ready. User ID:", userId);
                        
                        startBonusTimer();
                        setupEventListeners();
                        
                        listenToGameState();
                    } else {
                        await signInAnonymously(auth);
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                isAuthReady = true;
                userId = 'mock-' + crypto.randomUUID(); 
                userIdDisplayEl.textContent = 'MOCK';
                console.warn("Running in Mock Mode (No Persistence).");
                
                gameState = loadGameFallback();
                calculateTotalBPS(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BPS
                updateUI();
                renderUpgrades();
                startBonusTimer()
