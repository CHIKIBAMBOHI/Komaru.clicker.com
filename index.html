<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FOREST SURVIVAL: FIXED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        /* ИСПРАВЛЕНИЕ: убираем синее выделение и подсветку тапов */
        * { 
            box-sizing: border-box; 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            -khtml-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #aaccff; position: fixed; font-family: sans-serif; }
        canvas { display: block; }
        #blood { position: fixed; inset: 0; pointer-events: none; z-index: 5; transition: 0.1s; box-shadow: inset 0 0 0px red; }
        #ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: none; color: #fff; }
        #ui * { pointer-events: auto; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; transform: translate(-50%, -50%); pointer-events: none; }
        #crosshair::before, #crosshair::after { content:''; position: absolute; background: #fff; }
        #crosshair::before { top: 11px; left: 0; width: 24px; height: 2px; }
        #crosshair::after { left: 11px; top: 0; width: 2px; height: 24px; }

        #radar-box { position: absolute; top: 20px; left: 20px; width: 120px; height: 120px; background: rgba(0, 20, 0, 0.7); border: 2px solid #4f4; border-radius: 5px; }
        #stats { position: absolute; top: 150px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; font-size: 14px; border-left: 4px solid #ff4444; }
        #joy-zone { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; }
        #joy-stick { position: absolute; width: 40px; height: 40px; background: #fff; border-radius: 50%; top: 30px; left: 30px; }
        #fire-btn { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: rgba(255,0,0,0.6); border: 4px solid #fff; border-radius: 50%; color: #fff; font-weight: bold; }
        #interact { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); padding: 12px 30px; background: #fff; color: #000; font-weight: bold; border-radius: 8px; display: none; }
        
        #menu, #death-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: #aaccff; }
        #death-screen { display: none; background: rgba(50,0,0,0.9); flex-direction: column; color: white; }
        .box { text-align: center; background: #2a2a2a; padding: 30px; border-radius: 20px; border: 1px solid #444; width: 280px; color: white; }
        .btn { padding: 15px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
<div id="blood"></div>
<canvas id="c"></canvas>

<div id="ui">
    <div id="crosshair"></div>
    <div id="radar-box"><canvas id="radar-canvas" width="120" height="120"></canvas></div>
    <div id="stats">
        [<span id="w-name">КУЛАКИ</span>]<br>
        HP: <span id="hp">100</span> | AMMO: <span id="ammo">0</span> | KILLS: <span id="kills">0</span>
    </div>
    <div id="interact">ДЕЙСТВИЕ</div>
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <button id="fire-btn">ОГОНЬ</button>
</div>

<div id="menu">
    <div class="box">
        <h3>ЛЕСНЫЕ ТЕНИ</h3>
        <input type="text" id="nick" value="Hunter" style="width:100%; padding:10px; margin:5px 0;">
        <input type="text" id="room" value="room1" style="width:100%; padding:10px; margin:5px 0;">
        <button class="btn" onclick="startGame()">ИГРАТЬ</button>
    </div>
</div>

<div id="death-screen">
    <h1 style="font-size: 50px;">ВЫ УБИТЫ</h1>
    <p>Монстры поглотили вашу душу</p>
    <button class="btn" style="width: 200px;" onclick="location.reload()">РЕСТАРТ</button>
</div>

<script>
let state = {started:false, dead:false, hp:100, ammo:0, weapon:'none', kills:0, doorOpen:false, nick:'', room:''};
let move={x:0,y:0}, look={lon:180, lat:0}, lastX, lastY, recoil = 0;
const monsters=[], supplies=[], otherPlayers={}, trees=[], arsenal=[];
let scene, camera, renderer, doorPivot, radarCtx, gun, roomNode;

const weapons = {
    'none': {name: 'КУЛАКИ', damage: 1, ammo: 0},
    'pistol': {name: 'ПИСТОЛЕТ', damage: 1, ammo: 12},
    'rifle': {name: 'АВТОМАТ', damage: 1, ammo: 30},
    'shotgun': {name: 'ДРОБОВИК', damage: 5, ammo: 8}
};

function startGame() {
    state.nick = document.getElementById('nick').value + "_" + Math.floor(Math.random()*999);
    state.room = document.getElementById('room').value;
    document.getElementById('menu').style.display='none';
    document.getElementById('ui').style.display='block';
    init();
    state.started = true;
    animate();
}

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xaaccff);
    scene.fog = new THREE.FogExp2(0xaaccff, 0.05);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.7, 0);

    renderer = new THREE.WebGLRenderer({canvas: document.getElementById('c'), antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({color: 0x223322}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);
    
    // Дом
    const wallM = new THREE.MeshStandardMaterial({color: 0x3d2b1f});
    const wall = (w,h,d,x,z) => {
        let m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), wallM);
        m.position.set(x,h/2,z); scene.add(m);
    };
    wall(10.5, 4, 0.5, 0, -5); wall(0.5, 4, 10.5, -5, 0); wall(0.5, 4, 10.5, 5, 0);
    wall(3.5, 4, 0.5, -3.5, 5); wall(3.5, 4, 0.5, 3.5, 5);
    const roof = new THREE.Mesh(new THREE.ConeGeometry(8, 4, 4), new THREE.MeshStandardMaterial({color: 0x2a1a0a}));
    roof.position.set(0, 6, 0); roof.rotation.y = Math.PI/4; scene.add(roof);

    doorPivot = new THREE.Group(); doorPivot.position.set(1.7, 0, 5); scene.add(doorPivot);
    let dm = new THREE.Mesh(new THREE.BoxGeometry(3.4, 3.8, 0.2), new THREE.MeshStandardMaterial({color: 0x1a0a00}));
    dm.position.set(-1.7, 1.9, 0); doorPivot.add(dm);

    // Оружие на тумбочке
    wall(2, 0.8, 1, -3.5, -3); 
    const createGun = (x, type, color) => {
        let g = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.5), new THREE.MeshStandardMaterial({color: color}));
        g.position.set(x, 0.9, -3); g.userData = {type: type}; scene.add(g); arsenal.push(g);
    };
    createGun(-3, 'pistol', 0x333333);
    createGun(-3.5, 'rifle', 0x111111);
    createGun(-4, 'shotgun', 0x442200);

    for(let i=0; i<300; i++) {
        let tx = (Math.random()-0.5)*400, tz = (Math.random()-0.5)*400;
        if(Math.abs(tx)<12 && Math.abs(tz)<12) continue;
        let tree = new THREE.Mesh(new THREE.ConeGeometry(2,8,6), new THREE.MeshStandardMaterial({color:0x0a1f0a}));
        tree.position.set(tx, 4, tz); scene.add(tree); trees.push(tree);
    }

    for(let i=0; i<15; i++) spawnM();
    for(let i=0; i<8; i++) spawnSupply();

    radarCtx = document.getElementById('radar-canvas').getContext('2d');

    // MULTIPLAYER SETUP
    gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    roomNode = gun.get('forest-multi-sync-' + state.room);
    roomNode.map().on((data, id) => {
        if (!data || id === state.nick) return;
        if (!otherPlayers[id]) {
            otherPlayers[id] = {
                mesh: new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshBasicMaterial({color: 0x00ccff})),
                pos: {x: 0, z: 0}
            };
            scene.add(otherPlayers[id].mesh);
        }
        otherPlayers[id].pos = {x: data.x, z: data.z};
        otherPlayers[id].mesh.position.set(data.x, 1, data.z);
    });
}

function spawnM() {
    let m = new THREE.Mesh(new THREE.BoxGeometry(1.5, 4.5, 1.5), new THREE.MeshBasicMaterial({color: 0x000000}));
    let a = Math.random()*6.28, r = 50+Math.random()*40;
    m.position.set(Math.cos(a)*r, 2.25, Math.sin(a)*r);
    m.userData = {hp: 2}; scene.add(m); monsters.push(m);
}

function spawnSupply() {
    let s = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0xffff00}));
    s.position.set((Math.random()-0.5)*200, 0.5, (Math.random()-0.5)*200);
    let l = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,200), new THREE.MeshBasicMaterial({color:0xffff00, transparent:true, opacity:0.2}));
    l.position.y = 100; s.add(l); scene.add(s); supplies.push(s);
}

function animate() {
    if(!state.started || state.dead) return;
    requestAnimationFrame(animate);

    if(recoil > 0) { look.lat += recoil; recoil *= 0.8; }
    doorPivot.rotation.y += ((state.doorOpen ? 1.6 : 0) - doorPivot.rotation.y) * 0.1;

    let dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
    let side = new THREE.Vector3().crossVectors(dir, camera.up).normalize();
    let nx = camera.position.x + (dir.x*-move.y + side.x*move.x)*0.16;
    let nz = camera.position.z + (dir.z*-move.y + side.z*move.x)*0.16;
    
    // Коллизии дома
    let canMove = true;
    if (Math.abs(nx) < 5.2 && Math.abs(nz) < 5.2) {
        if (Math.abs(nx) > 4.7 || Math.abs(nz) > 4.7) {
            if (!(nz > 4.5 && Math.abs(nx) < 1.7 && state.doorOpen)) canMove = false;
        }
    }
    if(canMove) { camera.position.x = nx; camera.position.z = nz; }

    camera.lookAt(new THREE.Vector3().setFromSphericalCoords(1, (90-look.lat)*Math.PI/180, look.lon*Math.PI/180).add(camera.position));

    // Синхронизация в сеть
    roomNode.get(state.nick).put({x: camera.position.x, z: camera.position.z});

    // Монстры
    monsters.forEach((m) => {
        let toP = new THREE.Vector3().subVectors(camera.position, m.position).normalize();
        m.position.x += toP.x * 0.08; m.position.z += toP.z * 0.08;
        if(camera.position.distanceTo(m.position) < 2) {
            state.hp = Math.max(0, state.hp - 0.4);
            document.getElementById('blood').style.boxShadow = 'inset 0 0 50px red';
            setTimeout(()=>document.getElementById('blood').style.boxShadow='none', 100);
        }
    });

    // Смерть
    if(state.hp <= 0 && !state.dead) {
        state.dead = true;
        document.getElementById('ui').style.display='none';
        document.getElementById('death-screen').style.display='flex';
    }

    // Припасы
    supplies.forEach((s, i) => {
        if(camera.position.distanceTo(s.position) < 2.5) {
            state.hp = 100; state.ammo += 40; scene.remove(s); supplies.splice(i,1);
            spawnSupply();
        }
    });

    // Действия
    let btn = document.getElementById('interact');
    btn.style.display = 'none';
    if(camera.position.distanceTo(new THREE.Vector3(0,0,5)) < 3) {
        btn.style.display='block'; btn.innerText = state.doorOpen ? "ЗАКРЫТЬ" : "ОТКРЫТЬ";
        btn.onclick=()=>{state.doorOpen=!state.doorOpen;};
    }
    arsenal.forEach(g => {
        if(camera.position.distanceTo(g.position) < 2) {
            btn.style.display='block'; btn.innerText = "ВЗЯТЬ " + weapons[g.userData.type].name;
            btn.onclick=()=>{ state.weapon = g.userData.type; state.ammo += 30; };
        }
    });

    // РАДАР
    radarCtx.fillStyle='#001100'; radarCtx.fillRect(0,0,120,120);
    const z = 0.5;
    radarCtx.strokeStyle='#00ff00';
    radarCtx.strokeRect(60-camera.position.x*z-5*z, 60-camera.position.z*z-5*z, 10*z, 10*z);
    supplies.forEach(s => { radarCtx.fillStyle='#ffff00'; radarCtx.fillRect(60+(s.position.x-camera.position.x)*z, 60+(s.position.z-camera.position.z)*z, 4, 4); });
    Object.values(otherPlayers).forEach(p => { radarCtx.fillStyle='#00ccff'; radarCtx.beginPath(); radarCtx.arc(60+(p.pos.x-camera.position.x)*z, 60+(p.pos.z-camera.position.z)*z, 3, 0, 7); radarCtx.fill(); });
    radarCtx.fillStyle='#ff0000'; radarCtx.beginPath(); radarCtx.arc(60,60,3,0,7); radarCtx.fill();

    document.getElementById('hp').innerText = Math.ceil(state.hp);
    document.getElementById('kills').innerText = state.kills;
    document.getElementById('ammo').innerText = state.ammo;
    document.getElementById('w-name').innerText = weapons[state.weapon].name;

    renderer.render(scene, camera);
}

// ОГОНЬ (УРОН ТЕПЕРЬ РАБОТАЕТ)
document.getElementById('fire-btn').ontouchstart = (e) => {
    e.preventDefault();
    if(state.weapon === 'none' || state.ammo <= 0) return;
    state.ammo--; recoil = 4;
    
    let ray = new THREE.Raycaster();
    // Направление стрельбы строго в центр экрана
    ray.setFromCamera({x:0, y:0}, camera); 
    
    let hits = ray.intersectObjects(monsters);
    if(hits.length > 0) {
        let m = hits[0].object;
        m.userData.hp -= weapons[state.weapon].damage;
        if(m.userData.hp <= 0) {
            scene.remove(m);
            monsters.splice(monsters.indexOf(m), 1);
            state.kills++;
            spawnM();
        }
    }
};

window.ontouchmove = e => {
    let t = [...e.touches].find(i => i.clientX > window.innerWidth/2);
    if(t) {
        if(lastX) look.lon -= (t.clientX - lastX)*0.3;
        if(lastY) look.lat = Math.max(-85, Math.min(85, look.lat - (t.clientY - lastY)*0.3));
        lastX=t.clientX; lastY=t.clientY;
    }
};
window.ontouchend = () => { lastX=null; lastY=null; };
const jz = document.getElementById('joy-zone');
jz.ontouchmove = e => {
    e.preventDefault(); let t = [...e.touches].find(i=>i.clientX < window.innerWidth/2); if(!t) return;
    let r=jz.getBoundingClientRect();
    move.x=(t.clientX-(r.left+50))/50; move.y=(t.clientY-(r.top+50))/50;
    document.getElementById('joy-stick').style.transform=`translate(${move.x*25}px,${move.y*25}px)`;
};
jz.ontouchend = () => { move={x:0,y:0}; document.getElementById('joy-stick').style.transform='none'; };
</script>
</body>
</html>
